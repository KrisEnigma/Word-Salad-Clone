<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>Game Salad</title>
    <!-- Actualizar rutas de assets -->
    <link rel="icon" href="assets/images/icon_tr.png" type="image/x-icon">
    <link rel="apple-touch-icon" href="assets/images/icon.png" />
    <meta name="theme-color" content="#262626">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="assets/manifest.json">

    <style>
        /* Solo mantener los estilos del loader que son cr√≠ticos */
        .js-loading-overlay {
            position: fixed;
            inset: 0;
            background: #121212;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            z-index: 99999;
            padding: 20px;
        }

        .js-loading-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }

        /* Barra de progreso moderna con brillo ne√≥n */
        .progress {
            position: relative;
            width: min(280px, 70vw);
            height: 8px;
            background: #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
            box-shadow:
                inset 0 2px 4px rgba(0, 0, 0, 0.2),
                0 0 10px rgba(52, 152, 219, 0.3);
        }

        .progress-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transform-origin: left;
            transform: scaleX(0);
            border-radius: 8px;
            box-shadow:
                0 0 20px rgba(52, 152, 219, 0.5),
                0 0 40px rgba(46, 204, 113, 0.3);
            animation: initial-progress 2s ease forwards paused;
            will-change: transform;
            position: relative;
        }

        /* Efecto de brillo ne√≥n */
        .progress-bar::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.2),
                    transparent);
            transform: translateX(-100%);
            animation: shine 1.5s linear infinite;
        }

        @keyframes initial-progress {
            0% {
                transform: scaleX(0);
            }

            15% {
                transform: scaleX(0.3);
            }

            40% {
                transform: scaleX(0.6);
            }

            80% {
                transform: scaleX(0.8);
            }

            100% {
                transform: scaleX(1);
            }
        }

        @keyframes shine {
            100% {
                transform: translateX(100%);
            }
        }
    </style>

   <script>
        // Desregistrar SW existente
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                    console.log('SW desregistrado');
                }
            });
        }
    </script>
    <script>
        // Mejorar el logging de carga
        console.group('üîÑ Inicio de carga');
        
        function logLoadEvent(event) {
            console.log(`Evento disparado: ${event.type}`, {
                timeStamp: event.timeStamp,
                target: event.target?.tagName || 'unknown'
            });
        }

        // Monitorear eventos clave
        ['DOMContentLoaded', 'load', 'readystatechange'].forEach(event => {
            document.addEventListener(event, logLoadEvent);
        });

        // Monitorear estado de fuentes
        document.fonts.ready.then(() => {
            console.log('‚úÖ Fuentes listas:', {
                loaded: document.fonts.check('1em "Rubik"'),
                status: document.readyState
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            console.group('üìë Estado del DOM');
            const overlay = document.querySelector('.js-loading-overlay');
            const progressBar = overlay.querySelector('.progress-bar');
            
            // Logging detallado de elementos cr√≠ticos
            console.log('Estado de elementos:', {
                title: document.querySelector('.title')?.offsetHeight || 'no height',
                board: document.querySelector('.board')?.children.length || 'empty',
                levelNumber: document.querySelector('.level-number')?.textContent || 'empty',
                timer: document.querySelector('.timer')?.textContent || 'empty'
            });
            
            Promise.all([
                document.fonts.ready,
                Promise.all(
                    Array.from(document.images)
                        .filter(img => !img.complete)
                        .map(img => new Promise(resolve => {
                            img.onload = img.onerror = () => {
                                console.log(`Imagen cargada: ${img.src}`);
                                resolve();
                            };
                        }))
                )
            ]).then(() => {
                console.log('‚úÖ Todos los recursos cargados');
                requestAnimationFrame(() => {
                    progressBar.style.animationPlayState = 'running';
                    document.body.offsetHeight; // Forzar reflow
                    document.dispatchEvent(new CustomEvent('resources-ready', {
                        detail: { timestamp: Date.now() }
                    }));
                });
            }).catch(error => {
                console.error('‚ùå Error cargando recursos:', error);
            });
            console.groupEnd();
        });

        // Contador de cambios para evitar spam
        let mutationCount = 0;
        
        // Monitorear recursos din√°micos con throttling
        const observer = new MutationObserver((mutations) => {
            mutationCount += mutations.length;
            
            // Solo logear cambios significativos
            const significantChanges = mutations.filter(m => 
                m.addedNodes.length && 
                Array.from(m.addedNodes).some(node => 
                    node.nodeType === 1 && // Solo elementos
                    ['TITLE', 'BOARD', 'LEVEL-NUMBER', 'TIMER'].includes(node.nodeName)
                )
            );

            if (significantChanges.length) {
                console.log('üé≤ Elementos cr√≠ticos a√±adidos:', {
                    elements: significantChanges.map(m => 
                        Array.from(m.addedNodes)
                            .filter(n => n.nodeType === 1)
                            .map(n => n.nodeName)
                    ).flat()
                });
            }
        });

        // Desconectar el observer despu√©s de la carga inicial
        document.addEventListener('load', () => {
            console.log(`üìä Total de mutaciones: ${mutationCount}`);
            observer.disconnect();
        }, { once: true });

        document.addEventListener('resources-ready', (event) => {
            console.log('üéÆ Recursos listos, iniciando observaci√≥n DOM');
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
    </script>
    <script>
        // Manejar la carga inicial
        document.addEventListener('DOMContentLoaded', () => {
            const overlay = document.querySelector('.js-loading-overlay');
            const progressBar = overlay.querySelector('.progress-bar');
            
            // Esperar a que todos los recursos est√©n listos
            Promise.all([
                // Esperar fuentes
                document.fonts.ready,
                // Esperar im√°genes
                Promise.all(
                    Array.from(document.images)
                        .filter(img => !img.complete)
                        .map(img => new Promise(resolve => {
                            img.onload = img.onerror = resolve;
                        }))
                )
            ]).then(() => {
                console.log('‚úÖ Recursos cargados');
                requestAnimationFrame(() => {
                    progressBar.style.animationPlayState = 'running';
                    // Forzar reflow
                    document.body.offsetHeight;
                    // Disparar evento de recursos listos
                    document.dispatchEvent(new Event('resources-ready'));
                });
            });

            progressBar.addEventListener('animationend', () => {
                overlay.classList.add('fade-out');
                // Forzar reflow nuevamente
                document.body.offsetHeight;
            });
        });
    </script>
    <noscript>
        <style>
            .js-loading-overlay { display: none !important; }
        </style>
    </noscript>
  <script type="module" crossorigin src="./assets/js/main.js"></script>
</head>

<body class="js-loading">
    <div class="js-loading-overlay">
        <div class="progress">
            <div class="progress-bar"></div>
        </div>
    </div>

    <div class="toolbar">
        <button class="menu">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 18L20 18" stroke-width="2" stroke-linecap="round" />
                <path d="M4 12L20 12" stroke-width="2" stroke-linecap="round" />
                <path d="M4 6L20 6" stroke-width="2" stroke-linecap="round" />
            </svg>
        </button>
        <div class="level-number"></div>
        <div class="timer"></div>
    </div>
    <div class="game-container">
        <div class="title-container">
            <h1 class="title" style="user-select: text; -webkit-user-select: text; -moz-user-select: text;"></h1>
        </div>
        <div class="board"></div>
        <div class="word-list"></div>
    </div>
    <div class="modal-overlay" id="modal">
        <div class="modal-content">
            <h2>Men√∫</h2>
            <div class="menu-options">
                <button id="theme-button">Cambiar Tema</button>
                <button id="reset-game">Reiniciar Nivel</button>
                <button id="vibration-toggle">Activar Vibraci√≥n</button>
                <button id="test-notification">Probar Notificaci√≥n</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="theme-modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="back-button">
                    <div class="arrow-left"></div>
                </button>
                <h2>Temas</h2>
            </div>
            <div class="theme-grid"></div>
        </div>
    </div>

    <div class="modal-overlay" id="victory-modal">
        <canvas id="confetti-canvas"></canvas>
        <div class="modal-content">
            <h2>¬°Nivel Completado!</h2>
            <p class="victory-time">Tiempo: <span id="final-time"></span></p>
            <div class="menu-options">
                <button id="restart-level">Reiniciar Nivel</button>
                <button id="next-level">Siguiente Nivel</button>
            </div>
        </div>
    </div>
</body>

</html>